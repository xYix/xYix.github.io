---
title: uoj#596 é¢˜è§£ - ã€é›†è®­é˜Ÿäº’æµ‹2021ã€‘ä¸‰ç»´ç«‹ä½“æ··å…ƒåŠ²
---

> **é¢˜ç›®å¤§æ„.**
>
> æ±‚é«˜ç»´å¤šé¡¹å¼ $\ln$ã€‚
>
> æ—¶é™ $4$sï¼Œå„ç»´é•¿åº¦ $n_i$ ä¹‹ç§¯ä¸è¶…è¿‡ $2.5\text{e}5$ã€‚

ä¸‹é¢è®°ç»´æ•°ä¸º $m$ã€‚

# 1. é«˜ç»´å¤šé¡¹å¼ä¹˜æ³•

æ¬²æ±‚ $\ln$ å¿…ç„¶è¦å…ˆè€ƒè™‘å¤šé¡¹å¼ä¹˜æ³•ã€‚æ¯«æ— ç–‘é—®ï¼Œæˆ‘ä»¬åªéœ€è¦å¯¹æ¯ä¸€ä¸ªæ–¹å‘åš DFTï¼Œå°±å¯ä»¥å¾—åˆ°æ»¡è¶³å¾ªç¯å·ç§¯çš„å¤šé¡¹å¼ä¹˜æ³•ï¼Œå…·ä½“æ¥è¯´åšåˆ°çš„æ˜¯
$$
(i_1,...)\oplus(j_1,...)=(i_1+j_1\bmod n_1,...)\\
h_{\mathbf k}=\sum_{\mathbf i\oplus\mathbf j=\mathbf k}f_{\mathbf i}g_{\mathbf j}
$$
åœ¨ä¸€ç»´æƒ…å†µä¸‹æˆ‘ä»¬æŠŠå¾ªç¯å·ç§¯å˜ä¸ºå·ç§¯çš„æ–¹æ³•å°±æ˜¯è¡¥é•¿åº¦ï¼Œäºæ˜¯ï¼Œä½ çš„ç¡®å¯ä»¥ç›´æ¥æŠŠæ¯ä¸€ç»´é•¿åº¦è¡¥åˆ° $4$ æ¥è®¡ç®—å­é›†å·ç§¯ï¼šåªä¸è¿‡å¤æ‚åº¦å¾ˆåŠ£è€Œå·²ï¼ˆå‡†ç¡®æ¥è¯´æ˜¯è¦é¢å¤–ä¹˜ä»¥ $2^m$ï¼‰ã€‚è¿™å½“ç„¶æ˜¯æ— æ³•æ¥å—çš„ï¼Œæ‰€ä»¥åŸé—®é¢˜çš„å…³é”®å®é™…ä¸Šåœ¨äº**å¦‚ä½•ä¸ç»™æ¯ä¸€ä½è¡¥é•¿åº¦**ã€‚

è¿˜æ˜¯è€ƒè™‘å­é›†å·ç§¯ï¼Œä¸€èˆ¬çš„å­é›†å·ç§¯è§£å†³ä¸Šé¢è¿™ä¸ªé—®é¢˜çš„ç­–ç•¥æ˜¯ç¼–ä¸€ä¸ªåˆé€‚çš„**å ä½å‡½æ•°** $|\mathbf i|$ï¼Œæ»¡è¶³
$$
\mathbf i\oplus \mathbf j=\mathbf k\land |\mathbf i|+|\mathbf j|=|\mathbf k|\Longleftrightarrow \mathbf i +\mathbf j=\mathbf k
$$
åœ¨å­é›†å·ç§¯ä¸­ï¼Œ$|\mathbf i|=\sum i$ã€‚ä½†æ˜¯å®ƒå¯¹åŸé—®é¢˜æ¥è¯´å€¼åŸŸå¤ªå¤§äº†å¹¶ä¸åˆé€‚ã€‚äº‹å®ä¸Šå€¼åŸŸè¶³å¤Ÿå°çš„å ä½å‡½æ•°ç”šè‡³æ˜¯ä¸å¤§å¯èƒ½å­˜åœ¨çš„ã€‚

ä½†æ˜¯å…¶å®æˆ‘ä»¬åªéœ€è¦ $\{|\mathbf i\ominus\mathbf j|+|\mathbf j|\}$ è¿™ä¸ªé›†åˆæ‰€åœ¨çš„åŒºé—´é•¿åº¦ $L$ è¾ƒå°å³å¯ï¼›è¿™æ ·æˆ‘ä»¬æŠŠå ä½å‡½æ•°æ¨¡ $L$ è¿ç®—å°±è¶³å¤Ÿäº†ã€‚EIls æ‰¾åˆ°çš„ä¸€ä¸ªæ»¡è¶³ä¸Šè¿°æ€§è´¨çš„å ä½å‡½æ•°å¦‚ä¸‹ã€‚

> è®° $c(\mathbf i)=i_1+i_2n_1+\ldots+i_kn_1n_2...n_{k-1}$ã€‚æ˜¾ç„¶ $\mathbf i$ å¯æŒ‰ $c(\mathbf i)$ å”¯ä¸€åœ°æ’æˆä¸€ä¸ªçº¿æ€§åºåˆ—ã€‚é‡æ–°å®šä¹‰ $\mathbf i \oplus\mathbf j=c^{-1}(c(\mathbf i)+c(\mathbf j))$ï¼ˆæ˜¾ç„¶è¿™ä¸ª $\oplus$ æ„ä¹‰ä¸‹çš„å·ç§¯åªéœ€è¦å¯¹æ•´ä¸ªåºåˆ—åšå¤šé¡¹å¼ä¹˜æ³•å³å¯ï¼‰ã€‚
>
> äºæ˜¯æˆ‘ä»¬åªéœ€è¦ç›‘æµ‹æ¯ä¸€ä½æ˜¯å¦è¿›ä½ï¼Œå…·ä½“æ¥è¯´
> $$
> |\mathbf i|=\lfloor c(\mathbf i)/n_1\rfloor+\lfloor c(\mathbf i)/n_1n_2\rfloor+\ldots
> $$
> æ˜¾ç„¶åœ°ï¼Œæ­¤å¤„ $L=k$ã€‚

äºæ˜¯è¿™å°±åœ¨ $\Theta(k\cdot \prod n\cdot\sum \log n)$ çš„æ—¶é—´å†…å®Œæˆäº†å¤šé¡¹å¼ä¹˜æ³•ã€‚

# 2. é«˜ç»´ Ln

ç‰›è¿­å’Œæ±‚å¯¼ç­‰å‡å¯ç›´æ¥æŒ‰æŠŠé«˜ç»´å¤šé¡¹å¼çœ‹æˆä¸€ç»´è¿›è¡Œæ“ä½œï¼Œæ­¤å¤„ä¸éªŒè¯äº†ã€‚ï¼ˆå¯è§ä¸Šè¿°å˜æ¢çš„æ€§è´¨æœ‰å¤šä¹ˆä¼˜ç§€â€¦â€¦æˆ‘åªèƒ½è†œæ‹œï¼‰

# 3. å‚è€ƒç‘‡ğŸ

å–œææœ€åŠ£è§£ç¬¬äºŒ

```cpp
#include<bits/stdc++.h>
using namespace std;

typedef long long ll;
typedef unsigned long long ull;

const int p = 998244353, g = 3, maxn = 1 << 19;
int qpow(int a, int k) {
	int ans = 1;
	for (; k; k >>= 1, a = (ull)a * a % p)
		if (k & 1) ans = (ull)ans * a % p;
	return ans;
}
int norm(int x) { return x >= p ? x - p : x; }
int mron(int x) { return x < 0 ? x + p : x; }
void add(int &x, int y) { if((x += y) >= p) x -= p; }
void sub(int &x, int y) { if((x -= y) < 0) x += p; }

int k;
int n[22], N = 1;
int a_[22][22];

vector<int> W[22];
int fac[maxn], ifac[maxn], inv[maxn];
int ppc[maxn];
void init(int n_) {
	for (int i = 0; i <= n_; i++) {
		W[i].resize(1 << i);
		int w = qpow(g, (p - 1) >> i);
		W[i][0] = 1;
		for (int j = 1; j <= 1 << i; j++) W[i][j] = (ull)W[i][j - 1] * w % p;
	}
	inv[1] = fac[0] = fac[1] = ifac[0] = ifac[1] = 1;
	for (int i = 2; i < 1 << n_; i++)
		fac[i] = (ull)fac[i - 1] * i % p,
		inv[i] = (ull)mron(-inv[p % i]) * (p / i) % p, assert((ull)inv[i] * i % p == 1),
		ifac[i] = (ull)ifac[i - 1] * inv[i] % p;
	for (int i = 0; i < 1 << n_; i++) {
		for (int j = 1, i1 = i; j <= k; j++) ppc[i] += i1 /= n[j];
		ppc[i] %= k;
	}
}

void DFT(int d[], int n) {
	for (int L = n - 1, x = 1 << L; L >= 0; L--, x >>= 1)
	for (int *j = d; j < d + (1 << n); j += x << 1)
	for (int *k0 = j, *k1 = j + x, *w = W[L + 1].data(); k0 < j + x; k0++, k1++, w++) {
		int t = *k1;
		*k1 = (ull)mron(*k0 - t) * *w % p;
		add(*k0, t);
	}
}
void iDFT(int d[], int n) {
	for (int L = 0, x = 1; L < n; L++, x <<= 1)
	for (int *j = d; j < d + (1 << n); j += x << 1)
	for (int *k0 = j, *k1 = j + x, *w = W[L + 1].data() + (x << 1); k0 < j + x; k0++, k1++, w--) {
		int t = (ull)*k1 * *w % p;
		*k1 = mron(*k0 - t);
		add(*k0, t);
	}
	int invx = qpow(1 << n, p - 2);
	for (int i = 0; i < 1 << n; i++) d[i] = (ull)d[i] * invx % p;
}

void clear(int d[][maxn], int n0) {
	for (int i = 0; i < k; i++) memset(d[i], 0, 4 << n0);
}
void Conv(int p_[][maxn], int q[][maxn], int r[][maxn], int n0) {
	clear(r, n0);
	for (int i1 = 0; i1 < k; i1++)
	for (int i2 = 0; i2 < k; i2++) {
		int i3 = (i1 + i2) % k;
		for (int j = 0; j < 1 << n0; j++) r[i3][j] = (r[i3][j] + (ull)p_[i1][j] * q[i2][j]) % p;
	}
	for (int i3 = 0; i3 < k; i3++) iDFT(r[i3], n0);
}
int d[maxn], ans[maxn], P[22][maxn], Q[22][maxn], R[22][maxn];
void Inv(int n0) {
	if(n0 == 0) {
		ans[0] = 1;
		return;
	}
	Inv(n0 - 1);
	int x = 1 << n0;
	clear(P, n0), clear(Q, n0);
	for (int i = 0; i < x; i++) P[ppc[i]][i] = ans[i], Q[ppc[i]][i] = d[i];
	for (int i = 0; i < k; i++) DFT(P[i], n0), DFT(Q[i], n0);
	Conv(P, Q, R, n0); clear(Q, n0);
	for (int i = x >> 1; i < x; i++) Q[ppc[i]][i] = R[ppc[i]][i];
	for (int i = 0; i < k; i++) DFT(Q[i], n0);
	Conv(P, Q, R, n0);
	for (int i = x >> 1; i < x; i++) ans[i] = mron(-R[ppc[i]][i]);
}

int main() {
	scanf("%d", &k);
	for (int i = 1; i <= k; i++) scanf("%d", &n[i]), N *= ++n[i];
	for (int i = 1; i <= k; i++)
	for (int j = 1; j <= k; j++) scanf("%d", &a_[i][j]), a_[i][j]++;
	int N_ = 0; while(1 << N_ < N) N_++; init(N_);
	for (int i = 0; i < 1 << N_; i++) {
		static int v[22];
		d[i] = 1;
		for (int j = 1, i1 = i; j <= k; i1 /= n[j++]) {
			v[j] = i1 % n[j];
			d[i] = (ull)d[i] * ifac[v[j]] % p;
		}
		for (int x = 1; x <= k; x++)
		for (int y = x; y <= k; y++)
			d[i] = (ull)d[i] * qpow(a_[x][y], x == y ? (ull)v[x] * (v[x] - 1) / 2 % (p - 1) : v[x] * v[y]) % p;
	}
	Inv(N_);
	int ANS = 0;
	for (int i = 0; i < N; i++) ANS = (ANS + (ull)ans[i] * d[N - i - 1] % p * (N - i - 1)) % p;
	ANS = (ull)ANS * qpow(N - 1, p - 2) % p;
	for (int i = 1; i <= k; i++) ANS = (ull)ANS * fac[n[i] - 1] % p;
	printf("%d\n", ANS);
}
```

